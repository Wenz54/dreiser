# üî• DRAIZER V2.0 - MIGRATION SUMMARY

## BINANCE+BYBIT ‚Üí BITFINEX+DERIBIT

**–î–∞—Ç–∞:** 2025-10-29  
**–í–µ—Ä—Å–∏—è:** 2.0.00  
**–¶–µ–ª—å:** Spot-Futures –∞—Ä–±–∏—Ç—Ä–∞–∂ —Å –ø–∏–Ω–≥–æ–º 0.8ms

---

## üìä –ö–õ–Æ–ß–ï–í–´–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø

### 1Ô∏è‚É£ **–ë–ò–†–ñ–ò**

| –î–æ (V1.3.x) | –ü–æ—Å–ª–µ (V2.0) | –ü—Ä–∏—á–∏–Ω–∞ |
|-------------|--------------|---------|
| Binance (spot) | ‚ùå Removed | –í—ã—Å–æ–∫–∞—è latency, –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è |
| Bybit (spot) | ‚ùå Removed | –ù–µ –Ω—É–∂–µ–Ω –¥–ª—è spot-futures |
| - | ‚úÖ **Bitfinex** (spot) | Ping 0.8ms, maker 0.1% |
| - | ‚úÖ **Deribit** (futures) | Ping 0.88ms, rebate -0.025%! |

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- Latency: 500-800ms ‚Üí **5-50ms** (–≤ 10-100 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ!)
- Fees: 0.1% ‚Üí **0.1075% effective** (—Å —É—á–µ—Ç–æ–º Deribit rebate)
- Funding: Deribit –∫–∞–∂–¥—ã–µ 8 —á–∞—Å–æ–≤ (–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ)

---

### 2Ô∏è‚É£ **–°–¢–†–ê–¢–ï–ì–ò–ò**

| –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –î–æ (V1.3.x) | –ü–æ—Å–ª–µ (V2.0) |
|-----------|-------------|--------------|
| 1 | Statistical arbitrage | **Spot-Futures arbitrage** |
| 2 | Cross-exchange | **Statistical arbitrage** |
| 3 | Triangular | **Triangular** |

#### **–ù–û–í–ê–Ø –û–°–ù–û–í–ù–ê–Ø –°–¢–†–ê–¢–ï–ì–ò–Ø: SPOT-FUTURES ARBITRAGE**

```c
// backend/c_engine/src/strategies/spot_futures_arbitrage.c

// Spreads (after fees):
#define SPOT_FUTURES_MIN_BPS      10.0    // 0.10% minimum
#define SPOT_FUTURES_TARGET_BPS   15.0    // 0.15% target
#define SPOT_FUTURES_FAT_BPS      25.0    // 0.25% fat opportunity

// Fees:
// - Bitfinex: 0.10% maker / 0.20% taker
// - Deribit:  -0.025% maker (rebate!) / 0.05% taker
// - Effective: ~0.1075% (mixed execution)

// Algorithm:
// 1. Compare Bitfinex SPOT with Deribit FUTURES
// 2. Calculate basis: (futures - spot) / spot * 10000 bps
// 3. Adjust for funding rate (3 periods = 24h hold)
// 4. Subtract fees + slippage
// 5. If net_spread >= 10 bps ‚Üí TRADE
```

**–î–≤–∞ —Ç–∏–ø–∞ –∞—Ä–±–∏—Ç—Ä–∞–∂–∞:**
- **Cash-and-Carry**: Futures > Spot ‚Üí Buy spot, Sell futures
- **Reverse Cash-and-Carry**: Spot > Futures ‚Üí Sell spot, Buy futures

---

### 3Ô∏è‚É£ **RISK MANAGEMENT**

**–û–±–Ω–æ–≤–ª–µ–Ω—ã spread thresholds:**

```c
// backend/c_engine/src/risk/hft_risk_manager.h

// OLD (Binance/Bybit):
#define ABSOLUTE_MIN_SPREAD_BPS   4.0    // ‚ùå
#define TARGET_SPREAD_BPS         6.0    // ‚ùå
#define FAT_OPPORTUNITY_BPS      12.0    // ‚ùå

// NEW (Bitfinex/Deribit):
#define ABSOLUTE_MIN_SPREAD_BPS   10.0   // ‚úÖ –£—á–∏—Ç—ã–≤–∞–µ—Ç fees
#define TARGET_SPREAD_BPS         15.0   // ‚úÖ –ö–æ–º—Ñ–æ—Ä—Ç–Ω–∞—è –∑–æ–Ω–∞
#define FAT_OPPORTUNITY_BPS       25.0   // ‚úÖ –ü—Ä–µ–º–∏—É–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
```

**Funding Rate —É—á–µ—Ç:**

```c
// –§–æ—Ä–º—É–ª–∞:
double funding_cost_bps = funding_rate_bps * EXPECTED_HOLD_PERIODS;  // 3x8h = 24h
double net_spread_bps = spread_bps - TOTAL_COST_BPS - funding_cost_bps;

// –ï—Å–ª–∏ funding —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∏–π (>0.10%) ‚Üí –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–¥–µ–ª–∫—É
```

---

### 4Ô∏è‚É£ **–ù–û–í–´–ï –§–ê–ô–õ–´**

#### **WebSocket Clients:**

```
backend/c_engine/src/network/bitfinex_ws.h
backend/c_engine/src/network/bitfinex_ws.c
backend/c_engine/src/network/deribit_ws.h
backend/c_engine/src/network/deribit_ws.c
```

**Bitfinex WebSocket:**
- URL: `wss://api-pub.bitfinex.com/ws/2`
- Format: `{"event":"subscribe","channel":"book","symbol":"tBTCUSD"}`
- Response: `[CHAN_ID, [[PRICE, COUNT, AMOUNT], ...]]`

**Deribit WebSocket:**
- URL: `wss://www.deribit.com/ws/api/v2`
- Format: JSON-RPC 2.0
- Subscribe: `{"jsonrpc":"2.0","method":"public/subscribe","params":{"channels":["book.BTC-PERPETUAL.raw"]}}`
- Includes: **funding rate** –≤ –∫–∞–∂–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏!

#### **Strategy:**

```
backend/c_engine/src/strategies/spot_futures_arbitrage.h
backend/c_engine/src/strategies/spot_futures_arbitrage.c
```

Target latency: **~7 microseconds** for opportunity detection

---

### 5Ô∏è‚É£ **–ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø**

**backend/c_engine/config/engine.json:**

```json
{
  "strategies": {
    "spot_futures": {
      "enabled": true,
      "priority": 1,
      "min_spread_bps": 10.0,
      "target_spread_bps": 15.0,
      "fat_spread_bps": 25.0
    },
    "statistical": {
      "enabled": true,
      "priority": 2
    },
    "triangular": {
      "enabled": true,
      "priority": 3
    }
  },
  "exchanges": {
    "bitfinex": {
      "enabled": true,
      "type": "spot",
      "ws_url": "wss://api-pub.bitfinex.com/ws/2",
      "ping_ms": 0.803
    },
    "deribit": {
      "enabled": true,
      "type": "futures_perpetual",
      "ws_url": "wss://www.deribit.com/ws/api/v2",
      "ping_ms": 0.882,
      "has_funding": true
    }
  }
}
```

---

### 6Ô∏è‚É£ **–°–ë–û–†–ö–ê (CMakeLists.txt)**

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

```cmake
# REMOVED:
# src/network/binance_ws.c
# src/network/bybit_ws.c
# src/network/mexc_ws.c (–∏ –¥—Ä—É–≥–∏–µ 5 –±–∏—Ä–∂)
# src/strategies/cross_exchange.c

# ADDED:
src/network/bitfinex_ws.c
src/network/deribit_ws.c
src/strategies/spot_futures_arbitrage.c
src/strategies/statistical_arbitrage.c
```

---

## üöß TODO (–æ—Å—Ç–∞–ª–æ—Å—å –¥–æ–¥–µ–ª–∞—Ç—å)

### ‚ùå **main.c** (–ß–ê–°–¢–ò–ß–ù–û –û–ë–ù–û–í–õ–ï–ù)

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
- ‚úÖ Includes –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- ‚úÖ –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã `g_bitfinex_client`, `g_deribit_client`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `g_funding_rates[]` –º–∞—Å—Å–∏–≤

**–ß—Ç–æ –ù–£–ñ–ù–û –î–û–î–ï–õ–ê–¢–¨:**

```c
// 1. –í initialize_components():
g_bitfinex_client = bitfinex_ws_create(symbols, num_symbols, g_price_feed);
bitfinex_ws_connect(g_bitfinex_client);

g_deribit_client = deribit_ws_create(symbols, num_symbols, g_price_feed);
deribit_ws_connect(g_deribit_client);

g_spot_futures = spot_futures_create(g_price_cache, symbols, num_symbols);
g_statistical = statistical_create(g_price_cache);

// 2. –í websocket_reader_thread():
// –ó–∞–º–µ–Ω–∏—Ç—å Binance/Bybit –Ω–∞:
while (g_running) {
    bitfinex_ws_process(g_bitfinex_client);
    deribit_ws_process(g_deribit_client);
}

// 3. –í main loop (–∑–∞–º–µ–Ω–∏—Ç—å cross_exchange_detect):
// –ü–æ–ª—É—á–∏—Ç—å funding rates –æ—Ç Deribit
for (int i = 0; i < num_symbols; i++) {
    g_funding_rates[i] = deribit_get_funding_rate(g_deribit_client, symbols[i]);
}

// –î–µ—Ç–µ–∫—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π
int num_opps = spot_futures_detect(g_spot_futures, opportunities, MAX_OPPS, g_funding_rates);

// 4. –í cleanup():
bitfinex_ws_destroy(g_bitfinex_client);
deribit_ws_destroy(g_deribit_client);
spot_futures_destroy(g_spot_futures);
statistical_destroy(g_statistical);
```

---

## üìà –û–ñ–ò–î–ê–ï–ú–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´

### **Performance:**

| –ú–µ—Ç—Ä–∏–∫–∞ | V1.3.x | V2.0 (Target) |
|---------|--------|---------------|
| Latency (Exchange‚ÜíUs) | 500-800 ms | **5-50 ms** |
| Detection time | ~50 Œºs | **~7 Œºs** |
| Opportunities/hour | 5-30 | **30-100** |
| Win Rate | 28-50% | **50-70%** (–ª—É—á—à–∏–π R:R) |

### **Spreads (Real Market):**

| Volatility | Spread Range | Frequency | Notes |
|------------|--------------|-----------|-------|
| Low | 0.08-0.12% | 5-15/hour | –ú–∏–Ω–∏–º—É–º –ø—Ä–∏–±—ã–ª–∏ |
| Normal | 0.15-0.25% | 10-30/hour | –ö–æ–º—Ñ–æ—Ä—Ç–Ω–∞—è –∑–æ–Ω–∞ |
| High | 0.25-0.50% | 30-100/hour | "–ñ–∏—Ä–Ω—ã–µ" –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ |

---

## ‚úÖ CHECKLIST

### **Development (Local):**
- [x] –°–æ–∑–¥–∞–Ω `bitfinex_ws.h/c`
- [x] –°–æ–∑–¥–∞–Ω `deribit_ws.h/c`
- [x] –°–æ–∑–¥–∞–Ω `spot_futures_arbitrage.h/c`
- [x] –û–±–Ω–æ–≤–ª–µ–Ω `hft_risk_manager.h` (spreads)
- [x] –û–±–Ω–æ–≤–ª–µ–Ω `engine.json`
- [x] –û–±–Ω–æ–≤–ª–µ–Ω `CMakeLists.txt`
- [ ] **–î–û–î–ï–õ–ê–¢–¨ `main.c`** (–æ—Å—Ç–∞–ª–æ—Å—å ~200 —Å—Ç—Ä–æ–∫)
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–±–æ—Ä–∫—É (–Ω–µ—Ç –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ C:)

### **Production (Ubuntu Server):**
- [ ] Deploy –Ω–∞ Ubuntu Server 22.04 LTS
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å RT kernel
- [ ] –ü—Ä–∏–º–µ–Ω–∏—Ç—å CPU isolation + tuning
- [ ] –°–æ–±—Ä–∞—Ç—å C-engine
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å + –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ latency
- [ ] –°–æ–±—Ä–∞—Ç—å orderbook data –¥–ª—è backtesting

---

## üÜò –ï–°–õ–ò –ß–¢–û-–¢–û –ù–ï –†–ê–ë–û–¢–ê–ï–¢

### **Compilation Error:**

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Å–µ –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç:
ls backend/c_engine/src/network/bitfinex_ws.c
ls backend/c_engine/src/network/deribit_ws.c
ls backend/c_engine/src/strategies/spot_futures_arbitrage.c

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å yyjson —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:
ldconfig -p | grep yyjson
```

### **Linker Error:**

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å yyjson:
cd /tmp
git clone https://github.com/ibireme/yyjson.git
cd yyjson && mkdir build && cd build
cmake .. && make -j4 && sudo make install
sudo ldconfig
```

### **main.c Errors:**

–ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç–∞—Ä—ã–π –∫–æ–¥ –∫–∞–∫ reference, –∑–∞–º–µ–Ω–∏ —Ç–æ–ª—å–∫–æ:
1. `#include "network/binance_ws.h"` ‚Üí `#include "network/bitfinex_ws.h"`
2. `binance_ws_*` ‚Üí `bitfinex_ws_*`
3. `cross_exchange_detect` ‚Üí `spot_futures_detect`
4. –î–æ–±–∞–≤—å `g_funding_rates` –º–∞—Å—Å–∏–≤
5. –ü–µ—Ä–µ–¥–∞–π `funding_rates` –≤ `spot_futures_detect()`

---

## üöÄ –ó–ê–ü–£–°–ö –ù–ê UBUNTU

–°–º. –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –≤:
**docs/UBUNTU_DEPLOYMENT_V2.md**

---

–£–¥–∞—á–∏! üî•

